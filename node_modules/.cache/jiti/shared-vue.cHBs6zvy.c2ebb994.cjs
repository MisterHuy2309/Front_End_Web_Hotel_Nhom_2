"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.u = useScript;var _scripts = require("unhead/scripts");
var _vue = require("vue");
var _vueBYLJNEcq = require("./vue.BYLJNEcq.mjs");

function registerVueScopeHandlers(script, scope) {
  if (!scope) {
    return;
  }
  const _registerCb = (key, cb) => {
    if (!script._cbs[key]) {
      cb(script.instance);
      return () => {
      };
    }
    let i = script._cbs[key].push(cb);
    const destroy = () => {
      if (i) {
        script._cbs[key]?.splice(i - 1, 1);
        i = null;
      }
    };
    (0, _vue.onScopeDispose)(destroy);
    return destroy;
  };
  script.onLoaded = (cb) => _registerCb("loaded", cb);
  script.onError = (cb) => _registerCb("error", cb);
  (0, _vue.onScopeDispose)(() => {
    script._triggerAbortController?.abort();
  });
}
function useScript(_input, _options) {
  const input = typeof _input === "string" ? { src: _input } : _input;
  const options = _options || {};
  const head = options?.head || (0, _vueBYLJNEcq.i)();
  options.head = head;
  const scope = (0, _vue.getCurrentInstance)();
  options.eventContext = scope;
  if (scope && typeof options.trigger === "undefined") {
    options.trigger = _vue.onMounted;
  } else if ((0, _vue.isRef)(options.trigger)) {
    const refTrigger = options.trigger;
    let off;
    options.trigger = new Promise((resolve) => {
      off = (0, _vue.watch)(refTrigger, (val) => {
        if (val) {
          resolve(true);
        }
      }, {
        immediate: true
      });
      (0, _vue.onScopeDispose)(() => resolve(false), true);
    }).then((val) => {
      off?.();
      return val;
    });
  }
  head._scriptStatusWatcher = head._scriptStatusWatcher || head.hooks.hook("script:updated", ({ script: s }) => {
    s._statusRef.value = s.status;
  });
  const script = (0, _scripts.useScript)(head, input, options);
  script._statusRef = script._statusRef || (0, _vue.ref)(script.status);
  registerVueScopeHandlers(script, scope);
  return new Proxy(script, {
    get(_, key, a) {
      return Reflect.get(_, key === "status" ? "_statusRef" : key, a);
    }
  });
} /* v9-2e70af4438e7969a */
